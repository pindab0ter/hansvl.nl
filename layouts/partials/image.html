{{ $title := .PlainText | default .Title }}
{{ $alt := .Title | default .PlainText }}

{{ $isGoldmarkImageContext := eq (printf "%T" .) "goldmark.imageLinkContext" }}
{{ if (not $isGoldmarkImageContext) }}
  {{ $alt = .Alt }}
{{ end }}

{{ if in .Destination "http" }}
  <figure>
    <img
      alt="{{ $alt }}"
      title="{{ $title }}"
      src="{{ .Destination }}"
      loading="lazy"
      class="rounded-lg"
    />
    <figcaption class="text-sm italic">
      {{ $alt | $.Page.RenderString }}
    </figcaption>
  </figure>
{{ else }}
  {{ $image := .Page.Resources.GetMatch .Destination }}

  {{ if not $image }}
    {{ errorf "image not found: %s" .Destination }}
  {{ end }}

  {{ if eq $image.MediaType.SubType "svg" }}
    <figure>
      <a href="{{ $image.RelPermalink }}">
        <img
          alt="{{ $alt }}"
          title="{{ $title }}"
          src="{{ $image.RelPermalink }}"
          loading="lazy"
          class="rounded-lg"
        />
      </a>
      <figcaption class="text-sm italic">
        {{ $alt | $.Page.RenderString }}
      </figcaption>
    </figure>
  {{ else }}
    {{ $placeholder := ($image.Resize "3x webp q65") }}
    {{ $tiny := ($image.Resize "376x webp") }}
    {{ $small := ($image.Resize "992x webp") }}
    {{ $medium := ($image.Resize "1400x webp") }}
    {{ $original := ($image.Resize (printf "%dx%d webp" $image.Width $image.Height)) }}


    <figure>
      <a href="{{ $image.RelPermalink }}">
        <picture>
          <source
            media="(max-width: 639px)"
            srcset="{{ with $tiny.RelPermalink }}{{ . }}{{ end }}"
          />

          <source
            media="(max-width: 767px)"
            srcset="{{ with $small.RelPermalink }}{{ . }}{{ end }}"
          />

          <source
            media="(max-width: 1023px)"
            srcset="{{ with $medium.RelPermalink }}{{ . }}{{ end }}"
          />

          <source
            media="(min-width: 1024px)"
            srcset="{{ with $original.RelPermalink }}{{ . }}{{ end }}"
          />

          <img
            alt="{{ $alt }}"
            title="{{ $title }}"
            src="{{ $image }}"
            height="{{ $image.Height }}"
            width="{{ $image.Width }}"
            loading="lazy"
            class="rounded-lg"
            style="background: url(data:image/jpeg;base64,{{ $placeholder.Content | base64Encode }}); background-size: cover;"
          />
        </picture>
      </a>
      <figcaption class="text-sm italic">
        {{ $alt | $.Page.RenderString }}
      </figcaption>
    </figure>
  {{ end }}
{{ end }}
